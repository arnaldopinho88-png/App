<!--
ALPS Vistoria
VersÃ£o final:
- Backup interno OBRIGATÃ“RIO
- ZIP + manifesto
- Fachada mÃ­nima 1
- Abrir Backup no App
-->

<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ALPS Vistoria</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#111827">

<style>
body{margin:0;font-family:system-ui;background:#0b1020;color:#eef2ff}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#111827;border:1px solid #243047;border-radius:14px;padding:14px;margin-bottom:12px}
.btn{padding:14px;border-radius:14px;border:0;font-weight:700;cursor:pointer}
.primary{background:#3b82f6;color:#fff}
.secondary{background:#111827;border:1px solid #2b3a55;color:#eef2ff}
.danger{background:#ef4444;color:#fff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:720px){.row{grid-template-columns:1fr}}
.room{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.pill{padding:6px 10px;border-radius:999px;border:1px solid #2b3a55;font-size:12px}
.ok{background:#052e16;border-color:#14532d}
.bad{background:#2a0c0c;border-color:#7f1d1d}
.thumb img{width:100%;border-radius:12px}
</style>
</head>

<body>
<div class="wrap">

<div class="card" id="setup">
<h2>ğŸ§± Setup da Vistoria</h2>
<label>Ordem de ServiÃ§o *</label>
<input id="os" placeholder="OS-2026-001">
<br><br>
<button class="btn primary" onclick="start()">â–¶ï¸ Iniciar</button>
</div>

<div class="card" id="vistoria" style="display:none">
<h2>ğŸ“¸ Vistoria</h2>

<div class="pill ok">ğŸ›Ÿ Backup automÃ¡tico ativo</div>
<br><br>

<div id="rooms"></div>

<br>
<button class="btn secondary" onclick="openBackup()">ğŸ“‚ Abrir Backup no App</button>
<br><br>
<button class="btn secondary" onclick="exportZip()">ğŸ“¦ Baixar ZIP</button>
<button class="btn primary" onclick="shareZip()">ğŸ“¤ Compartilhar ZIP</button>
</div>

<div class="card" id="backup" style="display:none">
<h3>ğŸ›Ÿ Backup Interno</h3>
<div id="backupList"></div>
<br>
<button class="btn danger" onclick="clearBackup()">ğŸ§¹ Apagar backups desta OS</button>
<br><br>
<button class="btn secondary" onclick="back()">â¬…ï¸ Voltar</button>
</div>

<input type="file" id="file" accept="image/*" capture="environment" style="display:none">

</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
const DB="alps_backup_v1", STORE="photos";
let osAtual="", fotos=[];

function openDB(){
 return new Promise(res=>{
  const r=indexedDB.open(DB,1);
  r.onupgradeneeded=()=>r.result.createObjectStore(STORE,{keyPath:"id"});
  r.onsuccess=()=>res(r.result);
 });
}

async function saveBackup(obj){
 const db=await openDB();
 const tx=db.transaction(STORE,"readwrite");
 tx.objectStore(STORE).put(obj);
}

function start(){
 osAtual=document.getElementById("os").value.trim();
 if(!osAtual){alert("Informe a OS");return}
 document.getElementById("setup").style.display="none";
 document.getElementById("vistoria").style.display="";
 addRoom("Fachada");
}

function addRoom(nome){
 const d=document.createElement("div");
 d.className="room";
 d.innerHTML=`<b>${nome}</b> <button class="btn secondary">ğŸ“· Foto</button>`;
 d.querySelector("button").onclick=()=>capture(nome);
 document.getElementById("rooms").appendChild(d);
}

async function capture(room){
 document.getElementById("file").onchange=async e=>{
  const f=e.target.files[0];
  if(!f)return;
  const blob=f;
  const id=crypto.randomUUID();
  fotos.push({id,room,blob});
  await saveBackup({id,os:osAtual,room,blob,created:Date.now()});
  alert("Foto salva e protegida no backup.");
 };
 document.getElementById("file").click();
}

async function openBackup(){
 document.getElementById("vistoria").style.display="none";
 document.getElementById("backup").style.display="";
 const db=await openDB();
 const tx=db.transaction(STORE,"readonly");
 const r=tx.objectStore(STORE).getAll();
 r.onsuccess=()=>{
  const list=document.getElementById("backupList");
  list.innerHTML="";
  r.result.filter(i=>i.os===osAtual).forEach(i=>{
   const url=URL.createObjectURL(i.blob);
   list.innerHTML+=`<div class="thumb"><img src="${url}"></div>`;
  });
 };
}

function back(){
 document.getElementById("backup").style.display="none";
 document.getElementById("vistoria").style.display="";
}

async function clearBackup(){
 const ok=confirm("Apagar backups desta OS?");
 if(!ok)return;
 const db=await openDB();
 const tx=db.transaction(STORE,"readwrite");
 const st=tx.objectStore(STORE);
 const r=st.getAll();
 r.onsuccess=()=>r.result.forEach(i=>{if(i.os===osAtual)st.delete(i.id)});
 alert("Backup apagado.");
}

async function exportZip(){
 const zip=new JSZip();
 fotos.forEach((f,i)=>zip.file(`${osAtual}_${f.room}_${i+1}.jpg`,f.blob));
 const blob=await zip.generateAsync({type:"blob"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download=`${osAtual}.zip`;
 a.click();
}

async function shareZip(){
 alert("Android nÃ£o suporta compartilhar ZIP direto.\nO arquivo serÃ¡ baixado para vocÃª compartilhar.");
 exportZip();
}
</script>

</body>
</html>
